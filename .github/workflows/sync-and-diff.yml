name: Sync and Check Diff from Upstream

on:
  schedule:
    - cron: '0 2 * * *'  # 每天北京时间上午10点
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/Aethersailor/Custom_OpenClash_Rules.git
          git fetch upstream

      - name: Merge upstream changes
        run: |
          git checkout main
          git merge upstream/main --allow-unrelated-histories -m "🔄 Sync from upstream"

      - name: Compare custom files
        id: check_diff
        run: |
          mkdir -p diff_output
          diff cfg/Custom_Clash_Full.ini Custom_Clash_Full_self.ini > diff_output/full.diff || true
          diff cfg/Custom_Clash_Smart_Full.ini Custom_Clash_Smart_Full_self.ini > diff_output/smart.diff || true

          if [ -s diff_output/full.diff ] || [ -s diff_output/smart.diff ]; then
            echo "true" > diff_output/diff_flag.txt
          else
            echo "false" > diff_output/diff_flag.txt
          fi

      - name: Push changes if any
        run: git push origin main

      - name: Create issue if differences exist
        if: success()
        run: |
          if grep -q "true" diff_output/diff_flag.txt; then
            echo "Creating issue for differences..."

            # Truncate diff if too long
            FULL_DIFF=$(head -c 3000 diff_output/full.diff || echo "无差异")
            SMART_DIFF=$(head -c 3000 diff_output/smart.diff || echo "无差异")

            ISSUE_BODY="发现上游更新与你的自定义规则存在差异，请手动检查并更新：

## 差异：Custom_Clash_Full.ini vs Custom_Clash_Full_self.ini
\`\`\`diff
$FULL_DIFF
\`\`\`

## 差异：Custom_Clash_Smart_Full.ini vs Custom_Clash_Smart_Full_self.ini
\`\`\`diff
$SMART_DIFF
\`\`\`

👉 请手动更新 *_self.ini 文件以保持同步。"

            gh issue list --state open --json title | grep "检测到规则文件更新差异" || \
            gh issue create --title "🔔 检测到规则文件更新差异" --body "$ISSUE_BODY"
          else
            echo "No differences found, skipping issue creation."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
