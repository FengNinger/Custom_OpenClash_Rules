name: Sync and Check Diff from Upstream

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/Aethersailor/Custom_OpenClash_Rules.git
          git fetch upstream

      - name: Merge upstream changes
        run: |
          git checkout main
          git merge upstream/main --allow-unrelated-histories -m "ğŸ”„ Sync from upstream"

      - name: Compare custom files
        id: check_diff
        run: |
          mkdir -p diff_output
          diff cfg/Custom_Clash_Full.ini Custom_Clash_Full_self.ini > diff_output/full.diff || true
          diff cfg/Custom_Clash_Smart_Full.ini Custom_Clash_Smart_Full_self.ini > diff_output/smart.diff || true

          if [ -s diff_output/full.diff ] || [ -s diff_output/smart.diff ]; then
            echo "true" > diff_output/diff_flag.txt
          else
            echo "false" > diff_output/diff_flag.txt
          fi

      - name: Push changes if any
        run: git push origin main

      - name: Create issue if differences exist
        if: success()
        run: |
          if grep -q "true" diff_output/diff_flag.txt; then
            echo "Creating issue for differences..."

            # Truncate diff if too long
            FULL_DIFF=$(head -c 3000 diff_output/full.diff || echo "æ— å·®å¼‚")
            SMART_DIFF=$(head -c 3000 diff_output/smart.diff || echo "æ— å·®å¼‚")

            ISSUE_BODY="å‘ç°ä¸Šæ¸¸æ›´æ–°ä¸ä½ çš„è‡ªå®šä¹‰è§„åˆ™å­˜åœ¨å·®å¼‚ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶æ›´æ–°ï¼š

## å·®å¼‚ï¼šCustom_Clash_Full.ini vs Custom_Clash_Full_self.ini
\`\`\`diff
$FULL_DIFF
\`\`\`

## å·®å¼‚ï¼šCustom_Clash_Smart_Full.ini vs Custom_Clash_Smart_Full_self.ini
\`\`\`diff
$SMART_DIFF
\`\`\`

ğŸ‘‰ è¯·æ‰‹åŠ¨æ›´æ–° *_self.ini æ–‡ä»¶ä»¥ä¿æŒåŒæ­¥ã€‚"

            gh issue list --state open --json title | grep "æ£€æµ‹åˆ°è§„åˆ™æ–‡ä»¶æ›´æ–°å·®å¼‚" || \
            gh issue create --title "ğŸ”” æ£€æµ‹åˆ°è§„åˆ™æ–‡ä»¶æ›´æ–°å·®å¼‚" --body "$ISSUE_BODY"
          else
            echo "No differences found, skipping issue creation."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
